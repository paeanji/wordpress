 /* 1 âœ… checkouté¡µé¢åŒè´¦å•æ”¹ä¸ºè®¢å•è¯¦æƒ…è°ƒæ•´ */
function change_checkout_billing_title($translated_text, $text, $domain) {
    if ($translated_text == 'è´¦å•è¯¦æƒ…') {
        $translated_text = 'è®¢å•è¯¦æƒ…';
    }
    return $translated_text;
}
add_filter('gettext', 'change_checkout_billing_title', 20, 3);
add_filter('woocommerce_ship_to_different_address_checked', '__return_false');


add_filter('woocommerce_add_message', function($message) {
    if (strpos($message, 'Customer matched zone') !== false) {
        return '';
    }
    return $message;
});



      /* 2 âœ… è´­ç‰©è½¦æ·»åŠ å…è¿è´¹æç¤º */
// æ˜¾ç¤ºâ€œå†ä¹° XX å³å¯å…è¿è´¹â€æç¤º
function custom_free_shipping_notice_after_shipping() {
    if (!WC()->cart->needs_shipping()) return;

    $base_currency    = get_option('woocommerce_currency');
    $current_currency = get_woocommerce_currency();
    $chosen_methods   = WC()->session->get('chosen_shipping_methods', []);
    $packages         = WC()->shipping()->get_packages();

    $min_amount = 0;
    foreach ($packages as $package) {
        $methods = WC_Shipping::instance()->load_shipping_methods($package);
        foreach ($methods as $method) {
            if ($method->id === 'free_shipping' && !empty($method->min_amount)) {
                $min_amount = $method->min_amount;
                break 2;
            }
        }
    }
    if (!$min_amount) return;

    $cart_total = WC()->cart->get_cart_contents_total();

    $rate = 1.0;
    if ($current_currency !== $base_currency) {
        $rates_option = get_option('woocommerce_multi_currency_exchange_rates', []);
        $rate = isset($rates_option[$current_currency]) ? floatval($rates_option[$current_currency]) : 1.0;
    }

    $has_paid_shipping = true;
    foreach ($chosen_methods as $method_id) {
        if (strpos($method_id, 'free_shipping') !== false) {
            $has_paid_shipping = false;
            break;
        }
    }

    if ($cart_total >= $min_amount) {
        echo '<div class="custom-shipping-notice">ğŸ‰ Congratulations! You have qualified for <strong>free shipping</strong>!</div>';
    } elseif ($has_paid_shipping) {
        $remain = ($min_amount - $cart_total) * $rate;
        echo '<div class="custom-shipping-notice">Spend <strong>' . wc_price($remain) . '</strong> more to get <strong>free shipping</strong>!</div>';
    }
}
add_action('woocommerce_after_shipping_rate', 'custom_free_shipping_notice_after_shipping', 10);

// è¾¾åˆ°å…é‚®æ—¶è‡ªåŠ¨éšè—ä»˜è´¹é…é€
add_filter('woocommerce_package_rates', 'hide_paid_shipping_when_free_available', 100, 2);
function hide_paid_shipping_when_free_available($rates) {
    $free = [];
    foreach ($rates as $id => $rate) {
        if (strpos($id, 'free_shipping') !== false) {
            $free[$id] = $rate;
            break;
        }
    }
    return $free ?: $rates;
}



   /* 3 âœ… æ·»åŠ ä¸€ä¸ªç»„åˆè¾“å‡ºï¼šå…ˆæ˜¾ç¤ºå±æ€§ï¼Œå†æ˜¾ç¤ºåŠ å…¥è´­ç‰©è½¦ */
add_action('woocommerce_single_product_summary', 'custom_show_attributes_and_add_to_cart', 25);

function custom_show_attributes_and_add_to_cart() {
    global $product;

    // è¾“å‡ºäº§å“å±æ€§
    $attributes = $product->get_attributes();
    if ( ! empty( $attributes ) ) {
        echo '<div class="custom-product-attributes">';
        wc_display_product_attributes( $product );
        echo '</div>';
    }

    // æ˜¾ç¤ºé»˜è®¤çš„åŠ å…¥è´­ç‰©è½¦ï¼ˆåŒ…å«æ•°é‡+æŒ‰é’®ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯å¤åˆ¶å†…å®¹ï¼Œè€Œæ˜¯è°ƒç”¨ WooCommerce å†…ç½®æ¨¡æ¿
    woocommerce_template_single_add_to_cart();
}




   /* 4 âœ… ç”¨æˆ·ç™»é™†è‡ªåŠ¨å‹¾é€‰ è®°ä½ */
// WooCommerce ç™»å½•è¡¨å•é»˜è®¤å‹¾é€‰â€œè®°ä½æˆ‘â€
add_action( 'wp_footer', 'auto_check_rememberme_wc_login' );
function auto_check_rememberme_wc_login() {
    // åªåœ¨â€œæˆ‘çš„è´¦æˆ·â€é¡µé¢æ‰§è¡Œ
    if ( is_account_page() && !is_user_logged_in() ) {
        ?>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var rememberMe = document.querySelector('#rememberme');
            if (rememberMe) {
                rememberMe.checked = true;
            }
        });
        </script>
        <?php
    }
}



   /* 5 âœ… ç”¨æˆ·æ³¨å†Œæ—¶å¯†ç éªŒè¯ */
// åœ¨ WooCommerce æ³¨å†Œè¡¨å•ä¸­æ·»åŠ â€œç¡®è®¤å¯†ç â€å­—æ®µ
add_action( 'woocommerce_register_form', 'add_confirm_password_field' );
function add_confirm_password_field() {
    ?>
    <p class="form-row form-row-wide">
        <label for="reg_password2"><?php _e( 'ç¡®è®¤å¯†ç ', 'woocommerce' ); ?> <span class="required">*</span></label>
        <input type="password" class="input-text" name="password2" id="reg_password2" />
    </p>
    <p class="form-row form-row-wide">
        <small>å¯†ç è‡³å°‘8ä½ï¼Œå¿…é¡»åŒ…å«è‡³å°‘1ä¸ªå¤§å†™å­—æ¯ã€å°å†™å­—æ¯å’Œæ•°å­—ã€‚</small>
    </p>
    <?php
}

// æ³¨å†Œæ—¶è¿›è¡Œå¯†ç å¼ºåº¦ + ç¡®è®¤éªŒè¯
add_action( 'woocommerce_register_post', 'validate_custom_password_rules', 10, 3 );
function validate_custom_password_rules( $username, $email, $validation_errors ) {
    if ( isset($_POST['password']) ) {
        $password  = $_POST['password'];
        $password2 = isset($_POST['password2']) ? $_POST['password2'] : '';

        // æ£€æŸ¥é•¿åº¦
        if ( strlen($password) < 8 ) {
            $validation_errors->add( 'password_short', __( 'å¯†ç å¿…é¡»è‡³å°‘åŒ…å« 8 ä¸ªå­—ç¬¦ã€‚', 'woocommerce' ) );
        }

        // å¿…é¡»åŒ…å«å¤§å†™å­—æ¯
        if ( !preg_match( '/[A-Z]/', $password ) ) {
            $validation_errors->add( 'password_no_upper', __( 'å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå¤§å†™å­—æ¯ã€‚', 'woocommerce' ) );
        }

        // å¿…é¡»åŒ…å«å°å†™å­—æ¯
        if ( !preg_match( '/[a-z]/', $password ) ) {
            $validation_errors->add( 'password_no_lower', __( 'å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå°å†™å­—æ¯ã€‚', 'woocommerce' ) );
        }

        // å¿…é¡»åŒ…å«æ•°å­—
        if ( !preg_match( '/[0-9]/', $password ) ) {
            $validation_errors->add( 'password_no_number', __( 'å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ•°å­—ã€‚', 'woocommerce' ) );
        }

        // æ£€æŸ¥ç¡®è®¤å¯†ç ä¸€è‡´æ€§
        if ( empty($password2) ) {
            $validation_errors->add( 'password2_empty', __( 'è¯·è¾“å…¥ç¡®è®¤å¯†ç ã€‚', 'woocommerce' ) );
        } elseif ( $password !== $password2 ) {
            $validation_errors->add( 'password_mismatch', __( 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚', 'woocommerce' ) );
        }
    }

    return $validation_errors;
}




   /* 6 âœ… æ›´æ”¹ WooCommerce "æ— è´§" æ–‡æœ¬ä¸º "å·²å”®å®Œ" */
function custom_out_of_stock_text($text) {
    if ('æ— è´§' === $text) {
        return 'å·²å”®å®Œ'; // æ›¿æ¢æˆä½ æƒ³æ˜¾ç¤ºçš„æ–‡æœ¬
    }
    return $text;
}
add_filter('woocommerce_get_availability_text', 'custom_out_of_stock_text');




 
   /* 7 âœ… æ‹¦æˆªè¿è´¹è§„åˆ™ï¼šè‹¥è´­ç‰©è½¦å«ç¦æ­¢å‘å¾€ä¸­å›½çš„äº§å“ï¼Œåˆ™ç¦ç”¨è¿è´¹ + è®°å½•äº§å“åç§° */
add_filter('woocommerce_package_rates', 'block_shipping_to_china_for_specific_products', 10, 2);
add_filter('woocommerce_cart_no_shipping_available_html', 'custom_no_shipping_message');
add_filter('woocommerce_no_shipping_available_html', 'custom_no_shipping_message');

function block_shipping_to_china_for_specific_products($rates, $package) {
    if ($package['destination']['country'] !== 'CN') {
        return $rates;
    }

    $blocked_products = [];

    foreach (WC()->cart->get_cart() as $cart_item) {
        $product = $cart_item['data'];
        $shipping_class_id = $product->get_shipping_class_id();
        $shipping_class = get_term($shipping_class_id, 'product_shipping_class');

        if ($shipping_class && $shipping_class->slug === 'no-ship-to-china') {
            $blocked_products[] = $product->get_name();
        }
    }

    if (!empty($blocked_products)) {
        WC()->session->set('blocked_china_products', $blocked_products);
        return [];
    }

    WC()->session->__unset('blocked_china_products');
    return $rates;
}

// 2. æç¤ºæ¶ˆæ¯ï¼Œå¸¦ .china-blocked-notice ç±»
function custom_no_shipping_message($default) {
    $blocked_products = WC()->session->get('blocked_china_products');

    if (!empty($blocked_products)) {
        $message = '<div class="china-blocked-notice"><strong>âš ï¸ ä»¥ä¸‹å•†å“æ— æ³•é…é€åˆ°ä¸­å›½ï¼Œè¯·å°†å…¶ä»è´­ç‰©è½¦ä¸­ç§»é™¤ï¼š</strong><ul>';
        foreach ($blocked_products as $name) {
            $message .= '<li class="product-name">' . esc_html($name) . '</li>';
        }
        $message .= '</ul></div>';
        return $message;
    }

    return $default;
}

// 3. æ³¨å…¥ CSS æ ·å¼
add_action('wp_head', function () {
    ?>
    <style>
        .china-blocked-notice {
            border-left: 4px solid #cc0000;
            background-color: #ffe6e6;
            color: #cc0000;
            padding: 1em 1.5em;
            margin: 2em 0 1em; /* ä¸Šè¾¹è·åŠ å¤§ä¸€ç‚¹ */
            font-weight: bold;
            font-size: 1.05em;
            border-radius: 5px;
        }

        .china-blocked-notice ul {
            margin-top: 0.5em;
            padding-left: 1.2em;
        }

        .china-blocked-notice .product-name {
            color: #333333; /* æ¢å¤æ­£å¸¸é¢œè‰² */
            font-weight: normal;
        }

        @media screen and (max-width: 768px) {
            .china-blocked-notice {
                margin-top: 3em; /* ç§»åŠ¨ç«¯å‘ä¸‹å¤šä¸€äº› */
            }
        }
    </style>
    <?php
});



 
   /* âœ…æ›´æ”¹å˜é‡äº§å“é€‰æ‹© */
add_action('wp_footer', function () {
    if (is_product()) :
    ?>
    <style>
        /* æœªé€‰æ‹©å˜ä½“æ—¶ï¼šçº¢è‰²è¾¹æ¡† + çº¢å­— */
        select.variation-unselected {
            border: 1px solid #cc0000 !important;
            color: #cc0000 !important;  
        }

        /* é€‰æ‹©åï¼šé»‘è‰²è¾¹æ¡† + é»‘è‰²å­—ä½“ */
        select.variation-selected {
            border: 1px solid #333 !important;
            color: #333 !important;
            font-weight: normal !important;
        }

    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selects = document.querySelectorAll('.variations_form select');

            selects.forEach(function (select) {
                const updateStyle = () => {
                    if (!select.value) {
                        select.classList.add('variation-unselected');
                        select.classList.remove('variation-selected');
                    } else {
                        select.classList.remove('variation-unselected');
                        select.classList.add('variation-selected');
                    }
                };

                updateStyle(); // é¡µé¢åŠ è½½æ—¶ç«‹å³åˆ¤æ–­ä¸€æ¬¡
                select.addEventListener('change', updateStyle);
            });
        });
    </script>
    <?php
    endif;
});
